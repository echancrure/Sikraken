#!/bin/bash
#
# Script: run_testcov.sh
# Author: Chris Meudec
# Date: May 2025
# Description: This script runs TestCov on the target source file using the tests generated by Sikraken.
# It takes two arguments:
#   1. The relative path to the C source file (e.g., ./../SampleCode/atry_bitwise.c or .i)
#   2. The data model for TestCov (e.g., -32 or -64)
# The script creates a zip archive of the test suite and runs TestCov on the specified C file.
# It generates an output directory in ./sikraken_output/$base_name/testcov
# Usage: ./run_testcov.sh <relative_path_to_c_file> <testcov_data_model>
# Example: ./run_testcov.sh ./../SampleCode/atry_bitwise.c -32
# Example: ./run_testcov.sh ./../SampleCode/atry_bitwise.i -32
# Dependencies: testcov, zip
# Check if the correct number of arguments is provided
if [ $# -ne 2 ]; then
    echo "Usage: $0 <relative_path_to_c_file> <testcov_data_model>"
    echo "Example: $0 ./../SampleCode/atry_bitwise.c -32"
    exit 1
fi
rel_path_c_file="$1"                    #e.g. ./../SampleCode/atry_bitwise.c or .i
testcov_data_model="$2"

file_name_no_ext="${rel_path_c_file%.*}"
base_name=$(basename "$file_name_no_ext")

zipfile="./sikraken_output/$base_name/test-suite.zip"
rm -f $zipfile                          #remove the zip file if it exists
zip -r $zipfile "./sikraken_output/$base_name/test-suite"   # Create a zip archive of the test suite
testcov_call="testcov $testcov_data_model --test-suite $zipfile $rel_path_c_file --output "./sikraken_output/$base_name/testcov" --reduction NONE --no-runexec --no-isolation --no-plots"
echo "CALL TO TESTCOV IS $testcov_call"
$testcov_call
if [ $? -ne 0 ]; then
    echo "ERROR: TestCov validation failed for $rel_path_c_file"
    exit 1
fi